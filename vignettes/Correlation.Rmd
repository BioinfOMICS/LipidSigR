---
title: "LipidSigR tutorial - Correlation"
author:
- name: Wei-Chung Cheng
  affiliation: China Medical University
output:
  #BiocStyle::pdf_document: default
  BiocStyle::html_document:
    #toc_float: true
bibliography: ref.bib
csl: nature.csl

vignette: |
  %\VignetteIndexEntry{LipidSigR tutorial - Correlation}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE)
knitr::opts_chunk$set(fig.width = 6, fig.height = 5)
knitr::opts_chunk$set(fig.align ="center")
```

```{r style, echo = FALSE, results = 'asis'} 
        BiocStyle::markdown()
```


```{r load_package, message = FALSE}

```
```{r , message = FALSE, echo=FALSE}
library(LipidSigR)
library(plotly)
```

In the final part, we are going conduct a comprehensive correlation analysis to interrogate the clinical features that connect to lipids species and other mechanistically relevant lipid characteristics. Correlation analysis between lipids and clinical features is broadly used in many fields of study, such as Bowler RP et al. discovering that sphingomyelins are strongly associated with emphysema and glycosphingolipids are associated with COPD exacerbations [@bowler2015plasma]. 
    
The correlation analysis can be conducted by **"lipid species"** or **"lipid characteristics"**. In lipid species analysis, data are analyzed by lipid species. As to lipid characteristics analysis, the expression of all lipid species in the same categories of a selected characteristic is summed up for analysis. 
    
This section is designed for continuous clinical data. Two correlation analyses are accessible, **'Correlation Coefficient'** and **'Linear Regression'**. A heatmap will be shown once the correlation analysis is completed, it depicts the pattern between lipid species/lipid characteristics and clinical features. 
    
The available clustering methods are as follows. 

* Distance measurement: Pearson, Spearman, Kendall, Euclidean, Maximum, Manhattan, Canberra, Binary, and Minkowski.
* Clustering method: median, average, single, complete, Ward.D, Ward.D2, WPGMA, and UPGMC

# Input data
First, we have to read the input data needed for the correlation analysis section. We have to prepare lipid expression data (`exp_data`), lipid characteristics table (`lipid_char_table`), a condition table of sample names and clinical conditions (`condition_table`), and an adjusted table with additional variables for adjusting confounding effects (`adjusted_table`) as input data.
```{r load_correlation_data}
# clears all objects from workspace
rm(list = ls())

# lipid expression data
data("corr_exp_data")
exp_data <- corr_exp_data
head(exp_data[, 1:5], 5)

# lipid characteristics table
data("corr_lipid_char_table")
lipid_char_table <- corr_lipid_char_table
head(lipid_char_table, 5)

# condition table (clinical factor)
data("corr_condition_table")
condition_table <- corr_condition_table
head(condition_table,  5)

# adjusted table
data("corr_adjusted_table")
adjusted_table <- corr_adjusted_table
head(adjusted_table, 5)
```
After importing the input data, sometimes, we may need to conduct data processing before analysis. Here, we provide the `data_process` function for data processing, including removing features with missing values, missing values imputation, percentage transformation, log10 transformation, etc.
```{r corrrelation_data_process}
# lipid expression data
head(exp_data[, 1:5], 5)
# data processing of exp_data
exp_transform_table <- data_process(exp_data, exclude_var_missing=TRUE,
                                    missing_pct_limit=50, replace_zero=TRUE,
                                    zero2what='min', xmin=0.5, replace_NA=TRUE,
                                    NA2what='min', ymin=0.5, pct_transform=TRUE,
                                    data_transform=TRUE, trans_type='log',
                                    centering=FALSE, scaling=FALSE)
# exp_data after data processing
head(exp_transform_table[, 1:5], 5)
```

# Lipid species analysis
The following correlation analysis is conducted after lipids classified by lipid species.

## Correlation {#correlation}
The Correlation Coefficient gives a summary view that tells us whether a relationship exists between clinical features and lipid species, how strong that relationship is, and whether the relationship is positive or negative. We can decide the cut-offs for the correlation coefficient and the p-value by parameter `sig_cor_coef` and `sig_pvalue`. The rule of thumb in medical research recommended by Mukaka for interpreting the size of a correlation coefficient is provided below [@mukaka2012guide].


Size of Correlation          | Interpretation                             
-----------------------------|--------------------------------------------                   
0.90 to 1.00 (-.90 to -1.00) | Very high positive (negative) correlation
0.70 to .90 (-.70 to -.90)   | High positive (negative) correlation 
0.50 to .70 (-.50 to -.70)   | Moderate positive (negative) correlation
0.30 to .50 (-.30 to -.50)   | Low positive (negative) correlation     
0.00 to .30 (.00 to -.30)    | negligible correlation


```{r Correlation_lipid species: correlation}
# data processing of exp_data
exp_transform <- data_process(exp_data, exclude_var_missing=TRUE,
                              missing_pct_limit=50,
                              replace_zero=TRUE, zero2what='min',
                              xmin=0.5, replace_NA=TRUE,
                              NA2what='min', ymin=0.5,
                              pct_transform=TRUE, data_transform=TRUE,
                              trans_type='log', centering=FALSE, scaling=FALSE)
# compute correlation coefficient and visualize by heatmap
COspec_clinCor <- Clin_Cor_heatmap(exp_transform, condition_table,
                                   test = 'pearson', adjust_p_method = 'BH',
                                   sig_stat = 'p.adj', sig_pvalue=1,
                                   sig_cor_coef=0, heatmap_col='statistic',
                                   distfun='spearman', hclustfun='average')

# view result: data frame of clinical features and lipid species
head(COspec_clinCor$Cor_table_all[, 1:5], 5)

# view result: data frame of significant clinical features and lipid species
head(COspec_clinCor$Cor_table_sig[, 1:5], 5)

# view result: clinical features and lipid species correlation reorder matrix
head(COspec_clinCor$Cor_reorder_mat[, 1:2])
```

```{r , fig.cap = "Correlation coefficient for lipid species analysis. Only the variables that pass the defined cut-offs for p-value and the correlation coefficient are shown on the heatmap. The rows of the heatmap are clinical features and the columns are the lipid species."}
# view result: heatmap of clinical features and lipid species
COspec_clinCor$Cor_table_plot 
```


## Linear regression {#corr:LR}
Linear regression is a statistical technique that uses several explanatory variables to predict the outcome of a continuous response variable, allowing us to estimate the associations between lipid levels and clinical features. In multiple linear regression analysis, additional variables from the 'adjusted table' are added to the algorithm for adjusting the confounding effect. Once the calculation completes, a beta coefficient and t statistic (p-value) will be assigned to each lipid species, which can be chosen for clustering.
```{r Correlation_lipid species: linear regression}
# data processing of exp_data
exp_transform <- data_process(exp_data, exclude_var_missing=TRUE,
                              missing_pct_limit=50, replace_zero=TRUE,
                              zero2what='min', xmin=0.5, replace_NA=TRUE,
                              NA2what='min', ymin=0.5, pct_transform=TRUE,
                              data_transform=TRUE, trans_type='log',
                              centering=FALSE, scaling=FALSE)
# compute linear regression and visualize by heatmap
COspec_clin_LR <- Clin_LR_heatmap(exp_transform, condition_table,
                                  adjusted_table, adjust_p_method = 'BH',
                                  sig_stat = 'p.adj', sig_pvalue = 1,
                                  distfun='spearman', hclustfun='centroid',
                                  heatmap_col='beta_coef')

# view result: data frame of statistical results
head(COspec_clin_LR$LR_table_all[, 1:4], 5)

# view result: data frame of significant statistical results
head(COspec_clin_LR$LR_table_sig[, 1:4], 5)

# view result: matrix of heatmap
head(COspec_clin_LR$LR_reorder_mat[, 1:2])
```

```{r , fig.cap = "The heatmap of linear regression for lipid species analysis. Only the variables that pass the user-defined cut-offs for p-value and the correlation coefficient are shown on the heatmap. The rows of the heatmap are clinical features and the columns are the lipid species."}
# view result: heatmap of linear regression
COspec_clin_LR$LR_table_plot  
```

# Lipid characteristics analysis
The following correlation analysis is conducted after lipids are classified by lipid characteristics from the 'Lipid characteristics' table.

## Correlation
This section provides the correlation of lipid characteristics analysis. The Correlation Coefficient gives a summary view that tells us whether a relationship exists between clinical features and lipid species, how strong that relationship is, and whether the relationship is positive or negative. We can decide the cut-offs for the correlation coefficient and the p-value by parameter `sig_cor_coef` and `sig_pvalue`. The rule of thumb in medical research recommended by Mukaka for interpreting the size of a correlation coefficient is provided below [@mukaka2012guide].

Size of Correlation          | Interpretation                             
-----------------------------|--------------------------------------------                   
0.90 to 1.00 (-.90 to -1.00) | Very high positive (negative) correlation
0.70 to .90 (-.70 to -.90)   | High positive (negative) correlation 
0.50 to .70 (-.50 to -.70)   | Moderate positive (negative) correlation
0.30 to .50 (-.30 to -.50)   | Low positive (negative) correlation     
0.00 to .30 (.00 to -.30)    | negligible correlation

```{r Correlation_lipid characteristics: correlation}
# get lipid characteristics
char_var <- colnames(lipid_char_table)[-1]
# aggregated(sum) expression data by selected characteristics
exp_data_Spe2Char <- Species2Char(exp_data, lipid_char_table,
                                  char_var = char_var[1])
# data processing of exp_data_Spe2Char
exp_transform_class <- data_process(exp_data_Spe2Char, exclude_var_missing=TRUE,
                                    missing_pct_limit=50, replace_zero=TRUE,
                                    zero2what='NA', xmin=0.5, replace_NA=TRUE,
                                    NA2what='min', ymin=0.5, pct_transform=TRUE,
                                    data_transform=FALSE, trans_type='log',
                                    centering=FALSE, scaling=FALSE)
# compute correlation coefficient and visualize by heatmap
COchar_clinCor <- Clin_Cor_heatmap(exp_transform_class, condition_table,
                                   test = 'pearson', adjust_p_method = 'BH',
                                   sig_stat = 'p.adj', sig_pvalue=1,
                                   sig_cor_coef=0, heatmap_col='statistic',
                                   distfun='spearman', hclustfun='average')

# view result: data frame of clinical features and lipid characteristics
head(COchar_clinCor$Cor_table_all[, 1:5], 5)

# view result: data frame of significant clinical features and lipid characteristics
head(COchar_clinCor$Cor_table_sig[, 1:5], 5)

# view result: clinical features and lipid characteristics correlation reorder matrix
head(COchar_clinCor$Cor_reorder_mat[, 1:2])
```

```{r , fig.cap = "Correlation coefficient for lipid characteristics analysis. Only the variables that pass the defined cut-offs for p-value and the correlation coefficient are shown on the heatmap. The rows of the heatmap are clinical features and the columns are lipid characteristics."}
# view result: heatmap of clinical features and lipid characteristics
COchar_clinCor$Cor_table_plot 
```


## Linear regression
This section provides the linear regression of lipid characteristics analysis. Linear regression is a statistical technique that uses several explanatory variables to predict the outcome of a continuous response variable, allowing us to estimate the associations between lipid levels and clinical features. Lipids are classified and summed by the user-selected lipid characteristics (e.g., class), then implementing univariate or multivariate linear regression analysis with whether ‘adjusted table’ is provided. Each component in the selected characteristics will be assigned a beta coefficient and t statistic (p-value), which can be chosen for clustering.

```{r Correlation_lipid characteristics: linear regression}
# get lipid characteristics
char_var <- colnames(lipid_char_table)[-1]
# aggregated(sum) expression data by selected characteristics
exp_data_Spe2Char <- Species2Char(exp_data, lipid_char_table,
                                  char_var = char_var[1])
# data processing of exp_data_Spe2Char
exp_transform_class <- data_process(exp_data_Spe2Char, exclude_var_missing=TRUE,
                                    missing_pct_limit=50, replace_zero=TRUE,
                                    zero2what='NA', xmin=0.5, replace_NA=TRUE,
                                    NA2what='min', ymin=0.5, pct_transform=TRUE,
                                    data_transform=FALSE, trans_type='log',
                                    centering=FALSE, scaling=FALSE)
# compute linear regression and visualize by heatmap
COchar_clin_LR <- Clin_LR_heatmap(exp_transform_class, condition_table,
                                  adjusted_table, adjust_p_method = 'BH',
                                  sig_stat = 'p.adj', sig_pvalue = 1,
                                  distfun='spearman', hclustfun='centroid',
                                  heatmap_col='beta_coef')

# view result: data frame of statistical results
head(COchar_clin_LR$LR_table_all[, 1:4], 5)

# view result: data frame of significant statistical results
head(COchar_clin_LR$LR_table_sig[, 1:4], 5)

# view result: matrix of heatmap
head(COchar_clin_LR$LR_reorder_mat[, 1:2])
```

```{r , fig.cap = "The heatmap of linear regression for lipid characteristics analysis. Only the variables that pass the user-defined cut-offs for p-value and the correlation coefficient are shown on the heatmap. The rows of the heatmap are clinical features and the columns are the lipid characteristics."}
# view result: heatmap of linear regression
COchar_clin_LR$LR_table_plot 
```


# Session info
```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References

